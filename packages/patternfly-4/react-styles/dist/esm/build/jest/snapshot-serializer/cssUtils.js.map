{"version":3,"sources":["../../../../../src/build/jest/snapshot-serializer/cssUtils.js"],"names":["css","jsdom","JSDOM","getSelectors","nodes","reduce","selectors","node","props","getSelectorsFromProps","className","class","toString","split","map","cn","componentToHex","c","hex","length","rgbToHex","r","g","b","getComputedStyles","classNames","cssStr","dom","cs","window","getComputedStyle","document","body","children","values","i","key","value","getPropertyValue","replace","full","match","n","parseInt","getStylesAST","bufferedStyles","globalCSS","ast","parse","vars","getVarValue","stylesheet","rules","rule","type","declarations","decl","property","startsWith","formatComputedStyles","nodeSelectors","computedStyles","selector","join","cssString","Object","keys","k","stringify","getStyles","insertedStyles","acc","sel","re","RegExp","test","s"],"mappings":"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","sourcesContent":["import * as css from 'css';\nimport * as jsdom from 'jsdom';\n\nconst { JSDOM } = jsdom;\n\nfunction getSelectors(nodes) {\n  return nodes.reduce((selectors, node) => {\n    const props = typeof node.props === 'function' ? node.props() : node.props;\n    return [...selectors, getSelectorsFromProps(props)];\n  }, []);\n}\n\nfunction getSelectorsFromProps(props = {}) {\n  const className = props.className || props.class;\n  if (className) {\n    return className\n      .toString()\n      .split(' ')\n      .map(cn => `.${cn}`);\n  }\n  return [];\n}\n\nfunction componentToHex(c) {\n  const hex = c.toString(16);\n  return hex.length === 1 ? `0${hex}` : hex;\n}\n\nfunction rgbToHex(r, g, b) {\n  return `#${componentToHex(r)}${componentToHex(g)}${componentToHex(b)}`;\n}\n\nfunction getComputedStyles(classNames, cssStr) {\n  const dom = new JSDOM(\n    `<!DOCTYPE html>\n      <head><style>${cssStr}</style></head>\n      <body><div class=\"${classNames}\"></div>\n      </body>`\n  );\n  const cs = dom.window.getComputedStyle(dom.window.document.body.children[0]);\n  const values = {};\n  for (let i = 0; i < cs.length; i++) {\n    const key = cs[i];\n    const value = cs\n      .getPropertyValue(key)\n      .replace(/rgb\\(([\\d|,|\\s]+)\\)/g, (full, match) => rgbToHex(...match.split(',').map(n => parseInt(n, 10))));\n    values[key] = value;\n  }\n  return values;\n}\n\nfunction getStylesAST(bufferedStyles, globalCSS = '') {\n  const ast = css.parse(`${globalCSS}\\n${bufferedStyles}`);\n  const vars = {};\n  const getVarValue = value => value.replace(/var\\(([\\w|-]*)\\)/g, (full, match) => vars[match]);\n  ast.stylesheet.rules = ast.stylesheet.rules.map(rule => {\n    if (rule.type === 'rule') {\n      rule.declarations = rule.declarations.map(decl => {\n        if (decl.type === 'declaration') {\n          const { property, value } = decl;\n          if (property.startsWith('--')) {\n            vars[property] = getVarValue(value);\n          }\n          decl.value = getVarValue(value);\n        }\n        return decl;\n      });\n    }\n    return rule;\n  });\n  return ast;\n}\n\nfunction formatComputedStyles(nodeSelectors, computedStyles) {\n  const selector = nodeSelectors.join('');\n  const cssString = `${selector} {\n    ${Object.keys(computedStyles)\n      .map(k => `${k}: ${computedStyles[k]};`)\n      .join('\\n')}\n  }`;\n  return css.stringify(css.parse(cssString));\n}\n\nfunction getStyles(nodeSelectors, insertedStyles, globalCSS) {\n  if (!nodeSelectors.length) {\n    return '';\n  }\n  const ast = getStylesAST(insertedStyles, globalCSS);\n  return nodeSelectors\n    .reduce((acc, sel) => {\n      if (!sel.length) {\n        return acc;\n      }\n\n      const re = new RegExp(`(${sel.join('|')})`, 'g');\n      if (!re.test(insertedStyles)) {\n        return acc;\n      }\n\n      const computedStyles = getComputedStyles(sel.map(s => s.replace('.', '')).join(' '), css.stringify(ast));\n\n      return [...acc, formatComputedStyles(sel, computedStyles)];\n    }, [])\n    .join('\\n');\n}\n\nexport { getSelectors, getStyles };\n"],"file":"cssUtils.js"}